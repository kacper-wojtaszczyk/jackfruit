# Layer 2 — Raw Storage

Store immutable, versioned raw data from ingestion. Source-of-truth for reproducibility.

## Responsibilities

- File organization and naming conventions
- Retention policy
- Versioning (if same data is re-ingested)
- Providing read access to ETL layer

## Does NOT Do

- Transformation or parsing
- Serving queries to end-users
- Schema enforcement

## Technology

**Dev:** MinIO  
**Prod:** S3

S3-compatible API means code works unchanged across environments.

## Bucket Strategy

Two separate buckets:

| Bucket | Purpose |
|--------|---------|
| `jackfruit-raw` | Immutable, append-only, source-faithful |
| `jackfruit-curated` | Processed, query-optimized (written by ETL) |

**Why separate buckets:**
- Clear separation of concerns
- Easier lifecycle rules (raw kept longer, curated maybe pruned)
- Safety — ETL bugs can't corrupt raw data

## What "Raw" Means

Raw does **not** mean "cleaned". Raw means:

- As close to the source as possible
- No semantic transformation
- No aggregation or resampling
- No merging across sources

**Allowed:**
- Decompression (zip → NetCDF/GRIB) — happens at ingestion
- Checksums
- Format detection for extension (`.nc` vs `.grib2`)

**Not allowed:**
- Variable extraction or filtering
- Unit conversion
- Temporal/spatial subsetting

Think of raw as **evidence**, not data.

## Object Key Convention

**Pattern:**
```
{source}/{dataset}/{YYYY-MM-DD}/{run_id}.{ext}
```

**Example:**
```
ads/cams-europe-air-quality-forecasts-analysis/2025-03-12/01890c24-905b-7122-b170-b60814e6ee06.nc
ads/cams-europe-air-quality-forecasts-forecast/2025-03-12/01890c24-905b-7122-b170-b60814e6ee06.nc
ads/glofas-river-discharge/2025-03-12/01890c24-905b-7122-b170-b60814e6ee06.nc
```

**Key decisions:**
- Date is **ingest date** (when we fetched), not event date (which is inside the NetCDF)
- Dataset name encodes all request variants (e.g., `-analysis` vs `-forecast` for CAMS)
- Filename: `{run_id}.{ext}` — run_id is a UUIDv7 generated by orchestration (Dagster) and passed to ingestion
- Extension determined from actual format after unzipping (`.nc`, `.grib2`)
- Multiple ingests on the same date live under the same date prefix but have distinct run_ids (no overwrites)

**Rationale:**
- UUIDv7 keeps runs unique, time-sortable, and traceable across pipeline layers
- Date directory keeps listings human-friendly and time-scannable
- Uniform path depth across all sources and datasets
- ETL can discover files via prefix on date or by run_id metadata (future manifest)

## Immutability

- ETL reads from raw, writes to curated — **never mutates raw**
- Can delete curated, re-run ETL, rebuild from raw

## Open Questions

- [ ] Retention policy — keep forever? Archive to Glacier?
- [ ] Compression — at ingestion or leave as-is?
- [ ] Versioning — S3 versioning or timestamp in filename?
- [ ] Manifest per run to record inputs and checksums?
